{
  "name": "TikTok Video Complete Processor",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "analyze-video-complete",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-main",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        240,
        208
      ],
      "webhookId": "analyze-video-complete"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://royhen.app.n8n.cloud/webhook/process-video-nocode",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ video_url: $json.body.video_url }) }}",
        "options": {}
      },
      "id": "get-video-info",
      "name": "Get Video Info",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        464,
        208
      ]
    },
    {
      "parameters": {
        "url": "={{ $json.video_download_url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "download-video",
      "name": "Download Video",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        688,
        304
      ]
    },
    {
      "parameters": {
        "name": "={{ $('Get Video Info').item.json.author + '_' + $('Get Video Info').item.json.video_id + '.mp4' }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "root",
          "mode": "list"
        },
        "options": {}
      },
      "id": "upload-to-drive",
      "name": "Upload to Google Drive",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        912,
        400
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "ofFKlLc4IoxLD68F",
          "name": "Google Account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "transcribe-audio",
      "name": "Transcribe Audio",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        912,
        208
      ],
      "credentials": {
        "openAiApi": {
          "id": "p4lXz4PI3LIye0EB",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "numberInputs": 3,
        "options": {}
      },
      "id": "merge-all",
      "name": "Merge All",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        1184,
        192
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "=={{ {\n  \"model\": \"gpt-4o-mini\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"You are a metadata generator for TikTok videos. Generate:\\n1. Title: 50-100 characters, descriptive, specific, keyword-rich, covering BOTH visual and spoken content\\n2. Description: 2-3 sentences covering visual AND transcribed audio content\\n3. Tags: 5+ tags covering topic, style, mood, format, purpose. NO audience tags like 'viral', 'trending', 'popular'. Focus on content descriptors.\\n\\nReturn ONLY valid JSON with fields: title, description, tags (array)\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Visual Analysis: \" + $json.choices[0].message.content + \"\\n\\nTranscription: \" + ($json.text || \"No spoken words detected\") + \"\\n\\nGenerate metadata for this video.\"\n    }\n  ],\n  \"response_format\": { \"type\": \"json_object\" },\n  \"max_tokens\": 400\n} }}\n",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {}
      },
      "id": "generate-metadata",
      "name": "Generate Metadata",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1360,
        208
      ],
      "credentials": {
        "openAiApi": {
          "id": "p4lXz4PI3LIye0EB",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const videoInfo = $('Get Video Info').item.json;\nconst visualAnalysis = $('Visual Analysis').item.json.choices[0].message.content;\nconst transcription = $('Transcribe Audio').item.json.text;\nconst metadata = JSON.parse($('Generate Metadata').item.json.choices[0].message.content);\nconst googleDrive = $('Upload to Google Drive').item.json;\n\nreturn {\n  json: {\n    title: metadata.title,\n    description: metadata.description,\n    tags: metadata.tags,\n    transcription: transcription,\n    video_url: videoInfo.video_url,\n    video_id: videoInfo.video_id,\n    author: videoInfo.author,\n    duration: videoInfo.duration,\n    music: { title: videoInfo.music_title, artist: videoInfo.music_author },\n    visual_analysis: visualAnalysis,\n    google_drive: {\n      file_id: googleDrive.id,\n      file_name: googleDrive.name,\n      file_url: googleDrive.webViewLink || 'N/A'\n    },\n    processed_at: new Date().toISOString()\n  }\n};"
      },
      "id": "format-output",
      "name": "Format Final Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1584,
        208
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1808,
        208
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o\",\n  \"messages\": [\n    {\n      \"role\": \"user\",\n      \"content\": [\n        {\n          \"type\": \"text\",\n          \"text\": \"Analyze this TikTok video cover image. Provide detailed analysis covering:\\n1. Visual elements (people, objects, setting, colors, composition)\\n2. Style and mood (aesthetic, tone, atmosphere)\\n3. Any visible text or graphics\\n4. Overall impression and theme\\n\\nBe specific and detailed.\"\n        },\n        {\n          \"type\": \"image_url\",\n          \"image_url\": {\n            \"url\": \"{{ $('Get Video Info').item.json.cover_url }}\"\n          }\n        }\n      ]\n    }\n  ],\n  \"max_tokens\": 500\n}",
        "options": {}
      },
      "id": "visual-analysis",
      "name": "Visual Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        912,
        16
      ],
      "credentials": {
        "openAiApi": {
          "id": "p4lXz4PI3LIye0EB",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// CloudConvert async workflow with polling\nconst apiKey = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiIxIiwianRpIjoiNTA5OGI3MTIzYjNjYTNkOWEyNDJhYzg2MmQ0YTJiMjM5YWNjMGZhMTNlZTRlZTU1MmFiYjUxZjFhMzRlY2JkNzA3N2UzN2I0OTMzZWFlMzYiLCJpYXQiOjE3MzQ0NzAzMDQuMDE0MTIsIm5iZiI6MTczNDQ3MDMwNC4wMTQxMjIsImV4cCI6NDg4ODE0MzkwNC4wMDk4OTMsInN1YiI6IjczMDYwNjQ3Iiwic2NvcGVzIjpbInVzZXIucmVhZCIsInVzZXIud3JpdGUiLCJ0YXNrLnJlYWQiLCJ0YXNrLndyaXRlIiwid2ViaG9vay5yZWFkIiwid2ViaG9vay53cml0ZSIsInByZXNldC5yZWFkIiwicHJlc2V0LndyaXRlIl19.KbEAkJNXAO2lPyPn2YyO2JEzd2gOD0wGqJZNQGEaCOneBG52b0-Xh6vKL6Fh56OsYAiJYDwpJETv-yv9WYKb7EvEaWTrE3HqtqAp0rULjWW3ooP9v-qiNy8EIJnzQB2BWYPl5DYx-mnEBOXi8jqLnbWuBvZAjvTRs8kO3nHxbzkTSW9_L4L1HhvTKEOKZ4Tz5Og8Y5WrPk0NhWMW5qJqvRKdU0BkdGBOqpLcZnTt8uP2dHH8sLgS0EBrBpY-NxY7qjO-zTZZ0e0Y9UjJXjKPqn9F7oR1nMvzYqgfKwOZ3bL8ooOT7uHEAQo4Ol9n2FjE0hpN_kJT7gHgZZLXtbkKDQ';\nconst videoUrl = $('Get Video Info').item.json.video_download_url;\n\n// Step 1: Create job with import/url (no upload needed!)\nconst jobResponse = await $http.request({\n  method: 'POST',\n  url: 'https://api.cloudconvert.com/v2/jobs',\n  headers: {\n    'Authorization': `Bearer ${apiKey}`,\n    'Content-Type': 'application/json'\n  },\n  body: {\n    tasks: {\n      'import-video': {\n        operation: 'import/url',\n        url: videoUrl,\n        filename: 'video.mp4'\n      },\n      'convert-audio': {\n        operation: 'convert',\n        input: ['import-video'],\n        output_format: 'mp3',\n        audio_codec: 'mp3',\n        audio_bitrate: 128\n      },\n      'export-audio': {\n        operation: 'export/url',\n        input: ['convert-audio']\n      }\n    }\n  }\n});\n\nconst jobData = await jobResponse.json();\nconst jobUrl = jobData.data.links.self;\n\n// Step 2: Poll for completion (max 60 seconds)\nlet exportUrl = null;\nfor (let attempt = 0; attempt < 30; attempt++) {\n  await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2s\n\n  const statusResponse = await $http.request({\n    method: 'GET',\n    url: jobUrl,\n    headers: {\n      'Authorization': `Bearer ${apiKey}`\n    }\n  });\n\n  const statusData = await statusResponse.json();\n  const status = statusData.data.status;\n\n  if (status === 'finished') {\n    const exportTask = statusData.data.tasks.find(t => t.name === 'export-audio');\n    exportUrl = exportTask.result.files[0].url;\n    break;\n  } else if (status === 'error') {\n    throw new Error('CloudConvert conversion failed');\n  }\n}\n\nif (!exportUrl) {\n  throw new Error('CloudConvert job timed out after 60 seconds');\n}\n\n// Step 3: Download MP3\nconst mp3Response = await $http.request({\n  method: 'GET',\n  url: exportUrl,\n  encoding: 'arraybuffer'\n});\n\n// Return as binary data for Whisper\nreturn {\n  binary: {\n    data: mp3Response.body\n  }\n};\n"
      },
      "id": "cloudconvert-convert",
      "name": "CloudConvert Audio Extract",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        304
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Get Video Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Video Info": {
      "main": [
        [
          {
            "node": "Download Video",
            "type": "main",
            "index": 0
          },
          {
            "node": "Visual Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Video": {
      "main": [
        [
          {
            "node": "Upload to Google Drive",
            "type": "main",
            "index": 0
          },
          {
            "node": "CloudConvert Audio Extract",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload to Google Drive": {
      "main": [
        [
          {
            "node": "Merge All",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Audio": {
      "main": [
        [
          {
            "node": "Merge All",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge All": {
      "main": [
        [
          {
            "node": "Generate Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Metadata": {
      "main": [
        [
          {
            "node": "Format Final Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Final Output": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Visual Analysis": {
      "main": [
        [
          {
            "node": "Merge All",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Create CloudConvert Job": {
      "main": [
        [
          {
            "node": "Upload to CloudConvert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload to CloudConvert": {
      "main": [
        [
          {
            "node": "Wait for Conversion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Conversion": {
      "main": [
        [
          {
            "node": "Download MP3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download MP3": {
      "main": [
        [
          {
            "node": "Transcribe Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CloudConvert Audio Extract": {
      "main": [
        [
          {
            "node": "Transcribe Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  }
}